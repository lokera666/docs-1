<% hide_feedback = hide_feedback || false %>

<footer class="Footer">
  <hr />

  <% unless hide_feedback %>
    <div class="Footer__heading">How helpful was this page?</div>
    <div id="page-rating-widget" class="PageRating">
      <button class="PageRating__button" data-rating="-2" aria-label="Not helpful at all">üò¢</button>
      <button class="PageRating__button" data-rating="-1" aria-label="Not very helpful">üòï</button>
      <button class="PageRating__button" data-rating="1" aria-label="Helpful">üòä</button>
      <button class="PageRating__button" data-rating="2" aria-label="Very helpful">üòç</button>
    </div>
    <div id="page-rating-form" class="PageRating__form" style="display: none;">
      <label class="PageRating__label" for="page-rating-comment">How can we improve this page for you?</label>
      <textarea id="page-rating-comment" class="PageRating__textarea" placeholder="Optional" rows="3"></textarea>
      <label class="PageRating__label" for="page-rating-email">Would you like to chat with us?</label>
      <input id="page-rating-email" class="PageRating__input" type="email" placeholder="Optional - enter your email for us to reach out to you" />
      <button id="page-rating-submit" class="PageRating__submit Button Button--default">Submit Feedback</button>
    </div>
    <p>If you have questions or feedback</p>
    <div class="Footer__links">
      <a class="Button Button--default" href="https://github.com/buildkite/docs/issues">
        <img alt="Icon: issue" class="Button__icon Button__icon--16x16" src="<%= image_path('icons/issue.svg') %>" />
        Open an issue
      </a>
      <a class="Button Button--default" href="<%= open_source_url %>">
        <img alt="Icon: pull request" class="Button__icon Button__icon--16x16" src="<%= image_path('icons/pull-request.svg') %>" />
        Edit this page
      </a>
    </div>
    <hr />
  <% end %>

  <div class="Footer__heading">Need more help?</div>
  <div class="Footer__links">
    <% support_email = ("test-analytics".in? request.path) ? "support+analytics@buildkite.com" : "support@buildkite.com" %>
    <a class="Button Button--link" href="mailto:<%= support_email %>">
      <img alt="Icon: paper dart" class="Button__icon Button__icon--16x16" src="<%= image_path('icons/email.svg') %>" />
      Email support
    </a>
    <a class="Button Button--link" href="https://forum.buildkite.community/">
      <img alt="Icon: Discourse" class="Button__icon Button__icon--16x16" src="<%= image_path('icons/discourse.svg') %>" />
      Post on our forum
    </a>
  </div>
</footer>

<% unless hide_feedback %>
  <%= javascript_tag nonce: true do %>
    (function() {
      var widget = document.getElementById('page-rating-widget');
      var form = document.getElementById('page-rating-form');
      if (!widget || !form) return;

      var selectedRating = null;
      var buttons = widget.querySelectorAll('.PageRating__button');

      buttons.forEach(function(button) {
        button.addEventListener('click', function() {
          selectedRating = parseInt(this.getAttribute('data-rating'), 10);
          buttons.forEach(function(btn) { btn.classList.remove('PageRating__button--selected'); });
          this.classList.add('PageRating__button--selected');
          form.style.display = 'block';
        });
      });

      document.getElementById('page-rating-submit').addEventListener('click', function() {
        var comment = document.getElementById('page-rating-comment').value.trim();
        var email = document.getElementById('page-rating-email').value.trim();

        if (typeof posthog !== 'undefined') {
          posthog.capture('‚úçÔ∏è Docs page feedback', {
            rating: selectedRating,
            page_url: window.location.href,
            page_path: window.location.pathname,
            comment: comment || null,
            email: email || null
          });
        }

        form.style.display = 'none';
        widget.innerHTML = '<p class="PageRating__thanks">Thanks for your feedback üôè</p>';
      });
    })();
  <% end %>
<% end %>
